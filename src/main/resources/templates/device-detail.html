<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{layout/main :: head('Device Detail')}"></head>
<body>
    <nav th:replace="~{layout/main :: navbar}"></nav>

    <main class="container page-content">
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <div class="device-header">
            <div class="device-header-icon">
                <span th:text="${device.deviceType.icon}">device_unknown</span>
            </div>
            <div class="device-header-info">
                <h1 th:text="${device.displayName}">Device Name</h1>
                <div class="device-mac" th:text="${device.macAddress}">00:00:00:00:00:00</div>
                <div class="d-flex gap-1 mt-1">
                    <span th:if="${device.online}" class="badge badge-online">Online</span>
                    <span th:unless="${device.online}" class="badge badge-offline">Offline</span>
                    <span th:if="${device.trusted}" class="badge badge-trusted">Trusted</span>
                    <span th:if="${!device.known}" class="badge badge-unknown">Unknown</span>
                    <span th:if="${device.pinned}" class="badge badge-trusted">Pinned</span>
                </div>
            </div>
            <div class="device-header-actions" style="margin-left: auto; display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                <!-- Show all service URLs as buttons -->
                <th:block th:each="svc : ${device.serviceUrls}">
                    <a th:href="${svc.fullUrl}" target="_blank" class="btn btn-primary"
                       th:text="${svc.alias}" th:title="${svc.url}">Service</a>
                </th:block>
                <!-- Fallback to legacy serviceUrl if no serviceUrls defined -->
                <a th:if="${device.fullServiceUrl != null and device.serviceUrls.isEmpty()}"
                   th:href="${device.fullServiceUrl}" target="_blank" class="btn btn-primary">
                    Open Service
                </a>
                <form th:action="@{/devices/{id}/toggle-pin(id=${device.id})}" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-secondary"
                            th:text="${device.pinned} ? 'Unpin' : 'Pin to Dashboard'">Pin</button>
                </form>
            </div>
        </div>

        <div class="device-grid">
            <!-- Device Information -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Device Information</h3>
                </div>
                <div class="info-row">
                    <span class="info-label">MAC Address</span>
                    <span class="info-value" th:text="${device.macAddress}">00:00:00:00:00:00</span>
                </div>
                <div class="info-row">
                    <span class="info-label">IP Address</span>
                    <span class="info-value" th:text="${device.ipAddress ?: 'Not available'}">192.168.1.1</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Hostname</span>
                    <span class="info-value" th:text="${device.hostname ?: 'Not available'}">hostname</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Vendor</span>
                    <span class="info-value" th:text="${device.vendor ?: 'Unknown'}">Vendor</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Device Type</span>
                    <span class="info-value" th:text="${device.deviceType.displayName}">Unknown</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Connection Type</span>
                    <span class="info-value" th:text="${device.connectionType ?: 'Unknown'}">WiFi</span>
                </div>
                <div class="info-row">
                    <span class="info-label">First Seen</span>
                    <span class="info-value" th:text="${device.firstSeen != null} ? ${#temporals.format(device.firstSeen, 'yyyy-MM-dd HH:mm:ss')} : 'Unknown'">Date</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Last Seen</span>
                    <span class="info-value" th:text="${device.lastSeen != null} ? ${#temporals.format(device.lastSeen, 'yyyy-MM-dd HH:mm:ss')} : 'Unknown'">Date</span>
                </div>
                <div class="info-row" th:if="${device.openPorts}">
                    <span class="info-label">Open Ports</span>
                    <span class="info-value" th:text="${device.openPorts}">22, 80, 443</span>
                </div>
                <div class="info-row" th:if="${device.detectedOs}">
                    <span class="info-label">Detected OS</span>
                    <span class="info-value" th:text="${device.detectedOs}">Linux</span>
                </div>
                <div class="info-row" th:if="${device.lastDeepScan}">
                    <span class="info-label">Last Deep Scan</span>
                    <span class="info-value" th:text="${#temporals.format(device.lastDeepScan, 'yyyy-MM-dd HH:mm:ss')}">Date</span>
                </div>

                <!-- AI Identification -->
                <div th:if="${device.aiIdentification}" class="mt-3">
                    <h4 class="text-cyan">AI Identification</h4>
                    <p class="text-muted" th:text="${device.aiIdentification}">AI analysis result</p>
                </div>

                <div class="mt-3 d-flex gap-2">
                    <form th:action="@{/devices/{id}/deep-scan(id=${device.id})}" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-primary"
                                th:disabled="${device.ipAddress == null or device.ipAddress.isEmpty()}">
                            Deep Scan (nmap -A)
                        </button>
                    </form>
                    <form th:if="${langChain4jConfigured}" th:action="@{/devices/{id}/analyze-deepscan(id=${device.id})}" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-secondary"
                                th:disabled="${device.deepScanLog == null or device.deepScanLog.isEmpty()}"
                                th:title="${device.deepScanLog == null or device.deepScanLog.isEmpty()} ? 'Run a deep scan first' : 'Analyze deep scan log with AI'">
                            Analyze with AI
                        </button>
                    </form>
                    <form th:if="${aiEnabled}" th:action="@{/devices/{id}/identify-ai(id=${device.id})}" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-secondary">Identify with AI</button>
                    </form>
                </div>
            </div>

            <!-- Edit Device -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Edit Device</h3>
                </div>
                <form th:action="@{/devices/{id}/update(id=${device.id})}" method="post">
                    <div class="form-group">
                        <label class="form-label" for="customName">Custom Name</label>
                        <input type="text" id="customName" name="customName" class="form-control"
                               th:value="${device.customName}" placeholder="Enter a custom name">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="deviceType">Device Type</label>
                        <select id="deviceType" name="deviceType" class="form-control">
                            <option th:each="type : ${deviceTypes}"
                                    th:value="${type}"
                                    th:text="${type.displayName}"
                                    th:selected="${type == device.deviceType}">Type</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" id="known" name="known" class="form-check-input"
                                   th:checked="${device.known}" value="true">
                            <label for="known">Mark as Known Device</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" id="trusted" name="trusted" class="form-check-input"
                                   th:checked="${device.trusted}" value="true">
                            <label for="trusted">Mark as Trusted Device</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="notes">Notes</label>
                        <textarea id="notes" name="notes" class="form-control" rows="3"
                                  th:text="${device.notes}" placeholder="Add notes about this device"></textarea>
                    </div>

                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" id="pinned" name="pinned" class="form-check-input"
                                   th:checked="${device.pinned}" value="true">
                            <label for="pinned">Pin to Dashboard (for quick access)</label>
                        </div>
                    </div>

                    <!-- Hidden field to preserve legacy serviceUrl -->
                    <input type="hidden" name="serviceUrl" th:value="${device.serviceUrl}">

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <a th:href="@{/devices}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>

                <div class="mt-3" style="border-top: 1px solid var(--border-color); padding-top: 1rem;">
                    <form th:action="@{/devices/{id}/delete(id=${device.id})}" method="post"
                          onsubmit="return confirm('Are you sure you want to delete this device?');">
                        <button type="submit" class="btn btn-danger">Delete Device</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Service URLs -->
        <div class="card mt-3">
            <div class="card-header">
                <h3 class="card-title">Service URLs</h3>
            </div>

            <!-- Existing Services List -->
            <div th:if="${!device.serviceUrls.isEmpty()}" class="mb-3">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Alias</th>
                            <th>URL</th>
                            <th style="width: 150px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="svc : ${device.serviceUrls}">
                            <td>
                                <a th:href="${svc.fullUrl}" target="_blank" th:text="${svc.alias}">Service Name</a>
                            </td>
                            <td>
                                <code th:text="${svc.url}">:8080</code>
                                <small class="text-muted" th:if="${svc.fullUrl != svc.url}"
                                       th:text="' â†’ ' + ${svc.fullUrl}"></small>
                            </td>
                            <td>
                                <div class="d-flex gap-1">
                                    <button type="button" class="btn btn-secondary btn-sm edit-service-btn"
                                            th:data-id="${svc.id}"
                                            th:data-alias="${svc.alias}"
                                            th:data-url="${svc.url}">
                                        Edit
                                    </button>
                                    <form th:action="@{/devices/{id}/services/{svcId}/delete(id=${device.id}, svcId=${svc.id})}"
                                          method="post" style="display: inline;"
                                          onsubmit="return confirm('Delete this service URL?');">
                                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div th:if="${device.serviceUrls.isEmpty()}" class="text-muted mb-3">
                No service URLs configured. Add one below.
            </div>

            <!-- Add New Service Form -->
            <div style="border-top: 1px solid var(--border-color); padding-top: 1rem;">
                <h4>Add New Service</h4>
                <form th:action="@{/devices/{id}/services/add(id=${device.id})}" method="post">
                    <div class="d-flex gap-2 align-items-end">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label class="form-label" for="newAlias">Alias</label>
                            <input type="text" id="newAlias" name="alias" class="form-control"
                                   placeholder="e.g., Web UI, API, SSH" required>
                        </div>
                        <div class="form-group" style="flex: 2; margin-bottom: 0;">
                            <label class="form-label" for="newUrl">URL</label>
                            <input type="text" id="newUrl" name="url" class="form-control"
                                   placeholder="e.g., :8080 or /admin or http://..." required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                    <small class="text-muted">Relative paths (e.g., :8080, /admin) will use the device's IP address.</small>
                </form>
            </div>

            <!-- Edit Service Modal (hidden by default) -->
            <div id="editServiceModal" style="display: none; border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem;">
                <h4>Edit Service</h4>
                <form id="editServiceForm" method="post">
                    <div class="d-flex gap-2 align-items-end">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label class="form-label" for="editAlias">Alias</label>
                            <input type="text" id="editAlias" name="alias" class="form-control" required>
                        </div>
                        <div class="form-group" style="flex: 2; margin-bottom: 0;">
                            <label class="form-label" for="editUrl">URL</label>
                            <input type="text" id="editUrl" name="url" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <script th:inline="javascript">
            var deviceId = [[${device.id}]];

            document.addEventListener('DOMContentLoaded', function() {
                document.querySelectorAll('.edit-service-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var serviceId = this.getAttribute('data-id');
                        var alias = this.getAttribute('data-alias');
                        var url = this.getAttribute('data-url');

                        document.getElementById('editServiceModal').style.display = 'block';
                        document.getElementById('editAlias').value = alias;
                        document.getElementById('editUrl').value = url;
                        document.getElementById('editServiceForm').action = '/devices/' + deviceId + '/services/' + serviceId + '/update';
                    });
                });
            });

            function cancelEdit() {
                document.getElementById('editServiceModal').style.display = 'none';
            }
        </script>

        <!-- Deep Scan Log -->
        <div class="card" th:if="${device.deepScanLog != null and !device.deepScanLog.isEmpty()}">
            <div class="card-header">
                <h3 class="card-title">Deep Scan Log</h3>
                <span class="badge" th:text="'nmap -A -T4'">nmap</span>
            </div>
            <div class="scan-log-container">
                <pre class="scan-log" th:text="${device.deepScanLog}">Scan output will appear here...</pre>
            </div>
        </div>
    </main>

    <footer th:replace="~{layout/main :: footer}"></footer>
    <script th:src="@{/js/app.js}"></script>
</body>
</html>
